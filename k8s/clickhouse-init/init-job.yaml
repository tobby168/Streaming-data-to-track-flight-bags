apiVersion: batch/v1
kind: Job
metadata:
  name: clickhouse-init
  namespace: baggage-poc
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: clickhouse-init
          image: clickhouse/clickhouse-server:24.9
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -euo pipefail
              clickhouse-client --host clickhouse --user admin --password admin123 --multiquery < /init/ddl.sql
          volumeMounts:
            - name: ddl
              mountPath: /init/ddl.sql
              subPath: ddl.sql
      volumes:
        - name: ddl
          configMap:
            name: clickhouse-ddl
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: clickhouse-ddl
  namespace: baggage-poc
  labels:
    app: clickhouse
    component: init
data:
  ddl.sql: |
    CREATE DATABASE IF NOT EXISTS baggage;

    CREATE TABLE IF NOT EXISTS baggage.flight_kpis
    (
        flight_id String,
        airport_origin String,
        airport_dest String,
        dep_time DateTime,
        arr_time DateTime,
        loaded_pct Float64,
        missing_bags UInt32,
        freshness_sec UInt32,
        updated_at DateTime DEFAULT now()
    )
    ENGINE = MergeTree
    ORDER BY (flight_id, dep_time);

    CREATE TABLE IF NOT EXISTS baggage.bag_latest
    (
        bag_id String,
        itinerary_id String,
        customer_id String,
        flight_id String,
        leg_index UInt8,
        airport String,
        event_type String,
        event_time DateTime,
        ingest_time DateTime,
        attributes Map(String, String),
        updated_at DateTime DEFAULT now()
    )
    ENGINE = ReplacingMergeTree(updated_at)
    ORDER BY bag_id;

    CREATE TABLE IF NOT EXISTS baggage.bag_events
    (
        bag_id String,
        itinerary_id String,
        customer_id String,
        flight_id String,
        leg_index UInt8,
        airport String,
        event_type String,
        event_time DateTime,
        ingest_time DateTime,
        scan_point_id String,
        reader_type String,
        confidence Float64,
        attributes Map(String, String),
        updated_at DateTime DEFAULT now()
    )
    ENGINE = MergeTree
    ORDER BY (bag_id, event_time);

    CREATE TABLE IF NOT EXISTS baggage.alerts
    (
        flight_id String,
        rule_id String,
        window_start DateTime,
        severity String,
        payload String,
        created_at DateTime DEFAULT now()
    )
    ENGINE = MergeTree
    ORDER BY (flight_id, rule_id, window_start);

    CREATE TABLE IF NOT EXISTS baggage.itinerary_status
    (
        itinerary_id String,
        journey_state String,
        latest_event String,
        latest_event_time DateTime,
        connection_airport String,
        risk_reason String,
        updated_at DateTime DEFAULT now()
    )
    ENGINE = ReplacingMergeTree(updated_at)
    ORDER BY itinerary_id;

    -- Kafka ingestion tables + materialized views (ingest from Flink Kafka sinks)
    DROP TABLE IF EXISTS baggage.bag_events_mv;
    DROP TABLE IF EXISTS baggage.kafka_bag_events;
    DROP TABLE IF EXISTS baggage.bag_latest_mv;
    DROP TABLE IF EXISTS baggage.kafka_bag_latest;
    DROP TABLE IF EXISTS baggage.flight_kpis_mv;
    DROP TABLE IF EXISTS baggage.kafka_flight_kpis;
    DROP TABLE IF EXISTS baggage.alerts_mv;
    DROP TABLE IF EXISTS baggage.kafka_alerts;
    DROP TABLE IF EXISTS baggage.itinerary_status_mv;
    DROP TABLE IF EXISTS baggage.kafka_itinerary_status;

    CREATE TABLE baggage.kafka_bag_latest
    (
        bag_id String,
        itinerary_id String,
        customer_id String,
        flight_id String,
        leg_index UInt8,
        event_type String,
        airport String,
        event_time DateTime64(3),
        ingest_time DateTime64(3),
        attributes Map(String, String)
    )
    ENGINE = Kafka
    SETTINGS kafka_broker_list = 'kafka:9092',
             kafka_topic_list = 'baggage.bag.latest.v1',
             kafka_group_name = 'ch_bag_latest_v2',
             kafka_format = 'JSONEachRow',
             kafka_num_consumers = 1,
             kafka_handle_error_mode = 'stream',
             kafka_commit_every_batch = 0,
             kafka_max_block_size = 5000,
             kafka_skip_broken_messages = 1,
             date_time_input_format = 'best_effort';

    CREATE TABLE baggage.kafka_bag_events
    (
        event_id String,
        bag_id String,
        itinerary_id String,
        customer_id String,
        flight_id String,
        leg_index Int32,
        airport String,
        event_type String,
        event_time DateTime64(3),
        ingest_time DateTime64(3),
        scan_point_id String,
        reader_type String,
        confidence Float64,
        attributes Map(String, String)
    )
    ENGINE = Kafka
    SETTINGS kafka_broker_list = 'kafka:9092',
             kafka_topic_list = 'baggage.events.v1',
             kafka_group_name = 'ch_bag_events_v1',
             kafka_format = 'JSONEachRow',
             kafka_num_consumers = 1,
             kafka_handle_error_mode = 'stream',
             kafka_commit_every_batch = 0,
             kafka_max_block_size = 5000,
             kafka_skip_broken_messages = 1,
             date_time_input_format = 'best_effort';

    CREATE MATERIALIZED VIEW baggage.bag_events_mv TO baggage.bag_events AS
    SELECT
        bag_id,
        itinerary_id,
        customer_id,
        flight_id,
        toUInt8(leg_index) AS leg_index,
        airport,
        event_type,
        toDateTime(event_time) AS event_time,
        toDateTime(ingest_time) AS ingest_time,
        scan_point_id,
        reader_type,
        confidence,
        attributes,
        now() AS updated_at
    FROM baggage.kafka_bag_events
    WHERE bag_id != '' AND event_time > toDateTime64(0, 3);

    CREATE MATERIALIZED VIEW baggage.bag_latest_mv TO baggage.bag_latest AS
    SELECT
        bag_id,
        itinerary_id,
        customer_id,
        flight_id,
        leg_index,
        airport,
        event_type,
        toDateTime(event_time) AS event_time,
        toDateTime(ingest_time) AS ingest_time,
        attributes,
        now() AS updated_at
    FROM baggage.kafka_bag_latest
    WHERE bag_id != '' AND event_time > toDateTime64(0, 3);

    CREATE TABLE baggage.kafka_flight_kpis
    (
        flight_id String,
        window_start DateTime64(3),
        window_end DateTime64(3),
        events Int64,
        loaded Int64,
        missing Int64,
        freshness_sec Float64,
        severity String
    )
    ENGINE = Kafka
    SETTINGS kafka_broker_list = 'kafka:9092',
             kafka_topic_list = 'baggage.flight.kpis.v1',
             kafka_group_name = 'ch_flight_kpis_v2',
             kafka_format = 'JSONEachRow',
             kafka_num_consumers = 1,
             kafka_handle_error_mode = 'stream',
             kafka_commit_every_batch = 0,
             kafka_max_block_size = 5000,
             kafka_skip_broken_messages = 1,
             date_time_input_format = 'best_effort';

    CREATE MATERIALIZED VIEW baggage.flight_kpis_mv TO baggage.flight_kpis AS
    SELECT
        flight_id,
        splitByString('->', splitByChar('|', flight_id)[3])[1] AS airport_origin,
        splitByString('->', splitByChar('|', flight_id)[3])[2] AS airport_dest,
        toDateTime(window_start) AS dep_time,
        toDateTime(window_end) AS arr_time,
        if(events > 0, loaded / events, 0) AS loaded_pct,
        toUInt32(greatest(missing, 0)) AS missing_bags,
        toUInt32(greatest(freshness_sec, 0)) AS freshness_sec,
        now() AS updated_at
    FROM baggage.kafka_flight_kpis
    WHERE flight_id != '' AND window_start > toDateTime64(0, 3);

    CREATE TABLE baggage.kafka_alerts
    (
        flight_id String,
        window_start DateTime64(3),
        window_end DateTime64(3),
        severity String,
        missing Int64
    )
    ENGINE = Kafka
    SETTINGS kafka_broker_list = 'kafka:9092',
             kafka_topic_list = 'baggage.alerts.v1',
             kafka_group_name = 'ch_alerts_v2',
             kafka_format = 'JSONEachRow',
             kafka_num_consumers = 1,
             kafka_handle_error_mode = 'stream',
             kafka_commit_every_batch = 0,
             kafka_max_block_size = 5000,
             kafka_skip_broken_messages = 1,
             date_time_input_format = 'best_effort';

    CREATE MATERIALIZED VIEW baggage.alerts_mv TO baggage.alerts AS
    SELECT
        flight_id,
        if(severity = 'CRITICAL', 'freshness_lag', 'missing_bags') AS rule_id,
        toDateTime(window_start) AS window_start,
        severity,
        concat(
            '{\"missing\":', toString(missing),
            ',\"window_start\":\"', toString(window_start),
            '\",\"window_end\":\"', toString(window_end),
            '\"}'
        ) AS payload,
        now() AS created_at
    FROM baggage.kafka_alerts
    WHERE flight_id != '' AND window_start > toDateTime64(0, 3);

    CREATE TABLE baggage.kafka_itinerary_status
    (
        itinerary_id String,
        journey_state String,
        last_event_type String,
        last_airport String,
        last_event_time DateTime64(3),
        updated_at DateTime64(3)
    )
    ENGINE = Kafka
    SETTINGS kafka_broker_list = 'kafka:9092',
             kafka_topic_list = 'baggage.notifications.v1',
             kafka_group_name = 'ch_itinerary_status_v2',
             kafka_format = 'JSONEachRow',
             kafka_num_consumers = 1,
             kafka_handle_error_mode = 'stream',
             kafka_commit_every_batch = 0,
             kafka_max_block_size = 5000,
             kafka_skip_broken_messages = 1,
             date_time_input_format = 'best_effort';

    CREATE MATERIALIZED VIEW baggage.itinerary_status_mv TO baggage.itinerary_status AS
    SELECT
        itinerary_id,
        journey_state,
        last_event_type AS latest_event,
        toDateTime(last_event_time) AS latest_event_time,
        last_airport AS connection_airport,
        CASE
            WHEN journey_state = 'AT_RISK_FOR_CONNECTION' THEN 'transfer_in'
            WHEN journey_state = 'DELAYED_OR_REROUTED' THEN 'offloaded'
            WHEN journey_state = 'EXCEPTION' THEN 'unexpected_event'
            ELSE ''
        END AS risk_reason,
        now() AS updated_at
    FROM baggage.kafka_itinerary_status
    WHERE itinerary_id != '' AND last_event_time > toDateTime64(0, 3);
